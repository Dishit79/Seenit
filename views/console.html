<% layout('layout.html', {page: 'Console'}) %>

<div class="container mx-auto mt-6 center">

  <div class="relative flex">

  <div class="grid gap-4 grid-cols-1 grid-rows-1 mt-10">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">Seenit Server Status</h2>
        <div class="flex justify-center">
          <div id="statusGraph" class="radial-progress" style="--value:00.00; --size:12rem; --thickness: 10px;">0%</div>
        </div>
        <span>Version: v0.0.4</span>
        <span>Ip Adress: 10.0.0.145</span>
        <span>Uptime: 34Hr</span>
        <span>Storage: <progress class="progress w-56" value="43" max="100"></progress></span>
        <span>Ram: <progress class="progress w-56" value="3854336" max="10000000"></progress></span>
        <span>Cpu Cores: 4</span>
      </div>
    </div>
  </div>

  <div class="grid gap-4 grid-cols-1 grid-rows-1 mt-10 flex-1">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 id="websocketStatusParent" class="card-title">Bittorrent Client <div id="websocketStatus" class="badge badge-error">Disconnected</div></h2>
        <div class="overflow-auto max-h-96">
          <div id="downloadInfo" class="mockup-code">
            <!-- <pre data-prefix=">" class="text-warning"><code>installing...</code></pre> -->
            <!-- <pre data-prefix=">" class="text-success"><code>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. </code></pre> -->
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
</div>


<script type="text/javascript">

  let numMsg = 0

  getWebsocket()

  async function getWebsocket() {

    const socketServerRaw = await fetch(`http://${window.location.host}/api/torrent/current/ws`)
    const socketServer = await socketServerRaw.json()


    const ws = new WebSocket(socketServer.websocketLink);
    ws.onopen = () => onOpen();
    ws.onclose = () => onClose();
    ws.onmessage = (event) => onMessage(event);
  }

  function onOpen() {
    let statusDiv = document.getElementById('websocketStatus')
    statusDiv.className = "badge badge-primary"
    statusDiv.innerHTML = "Connected"
    console.log("worked?");

  }

  function onClose() {
    let statusDiv = document.getElementById('websocketStatus')
    statusDiv.className = "badge badge-error"
    statusDiv.innerHTML = "Disconnected"
    console.log("worked?");
  }

  function onMessage(e) {

     numMsg += 1
     let cleanData = ''

    let downloadInfo = document.getElementById('downloadInfo')
    let statusGraph = document.getElementById('statusGraph')

    if ((/ INFO  rqbit                     > \[0]: /g).test(e.data)){
      cleanData = e.data.replace(/ INFO  rqbit                     > \[0]: /g, "").split(',')
    } else {
      statusGraph.style = `--value:100; --size:12rem; --thickness: 10px;`
      statusGraph.innerHTML = "100.00%"
      return
    }


    statusGraph.style = `--value:${cleanData[0].replace(/%.*/g,"")}; --size:12rem; --thickness: 10px;`
    statusGraph.innerHTML = cleanData[0].replace(/ \(.*/g,"")

    if (numMsg > 15) {
      downloadInfo.innerHTML = ""
      downloadInfo.innerHTML += (`<pre data-prefix=">" class="text-success"><code>${cleanData}</code></pre>`)
      numMsg = 0
    } else {
      downloadInfo.innerHTML += (`<pre data-prefix=">" class="text-success"><code>${cleanData}</code></pre>`)
    }
  }









</script>
